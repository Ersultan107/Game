<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neural Maze Ultimate</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #0a0510; overflow: hidden; touch-action: none; font-family: sans-serif; }
        canvas { display: block; z-index: 2; position: absolute; }
        #ui { position: absolute; top: 30px; width: 100%; text-align: center; color: #ff4d94; letter-spacing: 5px; z-index: 10; font-size: 14px; text-transform: uppercase; text-shadow: 0 0 10px #ff4d94; }
        #joy-outer { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); z-index: 10; }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: white; border-radius: 50%; box-shadow: 0 0 20px #ff4d94; }
        #screamer { display: none; position: fixed; inset: 0; background: black; z-index: 9999; }
        #screamer img { width: 150%; height: 150%; position: absolute; top: -25%; left: -25%; object-fit: cover; }
        .shake { animation: sh 0.05s infinite; }
        @keyframes sh { 0% {transform: translate(0,0)} 50% {transform: translate(-20px, 20px)} 100% {transform: translate(20px, -20px)} }
        #start-screen { position: fixed; inset: 0; background: #0a0510; z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .btn { padding: 15px 60px; background: white; border-radius: 5px; font-weight: bold; text-transform: uppercase; color: black; cursor: pointer; letter-spacing: 2px; }
    </style>
</head>
<body>
    <div id="ui">SYSTEM LINK: NODE <span id="lvl">1</span> / 4</div>
    <div id="start-screen">
        <h2 style="color:white; font-weight:100; letter-spacing:10px; margin-bottom:30px;">NEURAL INTERFACE</h2>
        <div class="btn" onclick="start()">Initialize</div>
    </div>
    <canvas id="c"></canvas>
    <div id="joy-outer"><div id="joy-stick"></div></div>
    <div id="screamer"><img src="77307.jpg"></div>
    <audio id="bgm" src="bg-music.mp3" loop></audio>
    <audio id="scm" src="scream.mp3"></audio>

<script>
    const cvs = document.getElementById('c'), ctx = cvs.getContext('2d');
    const bgm = document.getElementById('bgm'), scm = document.getElementById('scm');
    const stick = document.getElementById('joy-stick');
    let level = 1, active = false, walls = [], player = {x:0, y:0, r:5}, finish = {x:0, y:0}, joy = {x:0, y:0};

    // Все уровни теперь сложные, как на фото!
    const maps = [
        // NODE 1 - Плотный, но проходимый
        [[1,1,1,1,1,1,1,1,1],[1,2,0,0,1,0,0,0,1],[1,1,1,0,1,0,1,0,1],[1,0,0,0,0,0,1,3,1],[1,1,1,1,1,1,1,1,1]],
        // NODE 2 - Больше поворотов
        [[1,1,1,1,1,1,1,1,1,1,1],[1,2,0,1,0,0,0,1,0,3,1],[1,0,0,1,0,1,0,1,0,1,1],[1,0,1,1,0,1,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1]],
        // NODE 3 - Почти как финал
        [[1,1,1,1,1,1,1,1,1,1,1],[1,2,0,0,0,1,0,0,0,0,1],[1,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,1,0,1,3,0,1],[1,0,1,1,1,1,0,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1]],
        // NODE 4 - МАКСИМАЛЬНЫЙ ЛАБИРИНТ (С ФОТО) + СКРИМЕР
        [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,2,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,0,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,1,0,0,0,1],
            [1,0,1,1,1,1,1,1,1,0,1,1,1,0,1],
            [1,0,1,0,0,0,0,0,1,0,0,0,1,0,1],
            [1,0,1,0,1,1,1,0,1,1,1,0,1,0,1],
            [1,0,0,0,1,0,1,0,0,0,0,0,1,0,1],
            [1,1,1,0,1,0,1,1,1,1,1,1,1,0,1],
            [1,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,1,1,1,1,0,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,1,0,1,3,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ]
    ];

    function start() {
        bgm.play().catch(()=>{}); scm.load();
        document.getElementById('start-screen').style.display='none';
        active = true; build(); loop();
    }

    function build() {
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        const m = maps[level-1];
        const size = Math.floor(cvs.width / (m[0].length + 1));
        walls = [];
        let ox = (cvs.width - m[0].length * size) / 2;
        let oy = (cvs.height - m.length * size) / 2.5;

        for(let y=0; y<m.length; y++) {
            for(let x=0; x<m[y].length; x++) {
                let px = ox + x * size, py = oy + y * size;
                if(m[y][x] === 1) walls.push({x: px, y: py, s: size});
                if(m[y][x] === 2) { player.x = px + size/2; player.y = py + size/2; }
                if(m[y][x] === 3) { finish.x = px + size/2; finish.y = py + size/2; }
            }
        }
    }

    window.addEventListener('touchmove', e => {
        if(!active) return;
        const r = document.getElementById('joy-outer').getBoundingClientRect();
        const t = e.touches[0];
        let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
        const d = Math.hypot(dx, dy);
        if(d > 40) { dx *= 40/d; dy *= 40/d; }
        stick.style.transform = `translate(${dx}px, ${dy}px)`;
        joy.x = dx / 11; joy.y = dy / 11;
    });

    window.addEventListener('touchend', () => { joy = {x:0, y:0}; stick.style.transform = 'translate(0,0)'; });

    function loop() {
        if(!active) return;
        let nx = player.x + joy.x, ny = player.y + joy.y;
        let col = false;

        for(let w of walls) {
            // Узкий хитбокс для прохода в сложных местах
            if(nx+3 > w.x && nx-3 < w.x+w.s && ny+3 > w.y && ny-3 < w.y+w.s) {
                col = true;
                if(level === 4) { end(); return; }
                break;
            }
        }

        if(!col) { player.x = nx; player.y = ny; }

        ctx.clearRect(0,0,cvs.width, cvs.height);
        walls.forEach(w => {
            ctx.strokeStyle = 'rgba(255, 77, 148, 0.5)';
            ctx.lineWidth = 1;
            ctx.strokeRect(w.x+1, w.y+1, w.s-2, w.s-2);
        });

        // Финиш
        ctx.fillStyle = '#ff4d94';
        ctx.shadowBlur = 10; ctx.shadowColor = '#ff4d94';
        ctx.beginPath(); ctx.arc(finish.x, finish.y, 8, 0, 7); ctx.fill();

        // Игрок
        ctx.fillStyle = 'white';
        ctx.shadowBlur = 15; ctx.shadowColor = 'white';
        ctx.beginPath(); ctx.arc(player.x, player.y, 5, 0, 7); ctx.fill();
        ctx.shadowBlur = 0;

        if(Math.hypot(player.x - finish.x, player.y - finish.y) < 12) {
            if(level < 4) { level++; document.getElementById('lvl').innerText = level; build(); }
            else { end(); }
        }
        requestAnimationFrame(loop);
    }

    function end() {
        active = false; bgm.pause(); scm.play();
        const s = document.getElementById('screamer');
        s.style.display = 'block'; s.classList.add('shake');
        if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
    }
</script>
</body>
</html>
