<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON MAZE: SHAKE EDITION</title>
    <style>
        :root { --neon: #00f3ff; --bg: #050508; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); overflow: hidden; touch-action: none; font-family: sans-serif; }
        canvas { display: block; }
        
        #ui { position: absolute; top: 30px; width: 100%; text-align: center; color: var(--neon); letter-spacing: 3px; z-index: 10; pointer-events: none; text-shadow: 0 0 8px var(--neon); }
        
        #joy-outer { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; border: 1px solid rgba(0, 243, 255, 0.3); border-radius: 50%; background: rgba(255,255,255,0.05); backdrop-filter: blur(5px); z-index: 10; }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: var(--neon); border-radius: 50%; box-shadow: 0 0 20px var(--neon); }
        
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .start-btn { padding: 15px 40px; background: transparent; border: 1px solid var(--neon); color: var(--neon); cursor: pointer; text-transform: uppercase; font-weight: bold; margin-top: 20px; box-shadow: 0 0 10px var(--neon); }

        /* СКРИМЕР И БЕШЕНАЯ ТРЯСКА */
        #screamer { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            background: black; 
            z-index: 9999; 
            overflow: hidden;
        }
        #screamer img { 
            width: 110%; /* Чуть больше экрана, чтобы при тряске не было пустых краев */
            height: 110%; 
            object-fit: cover; 
            position: absolute;
            top: -5%;
            left: -5%;
        }

        .shake-active { 
            animation: ultimate-shake 0.1s infinite; 
        }

        @keyframes ultimate-shake {
            0% { transform: translate(0,0) rotate(0deg); }
            10% { transform: translate(-10px, -5px) rotate(-1deg); }
            20% { transform: translate(10px, 5px) rotate(1deg); }
            30% { transform: translate(-5px, 10px) rotate(0deg); }
            40% { transform: translate(5px, -10px) rotate(1deg); }
            50% { transform: translate(-10px, 2px) rotate(-1deg); }
            60% { transform: translate(8px, 8px) rotate(0deg); }
            70% { transform: translate(-8px, -8px) rotate(-1deg); }
            80% { transform: translate(10px, -2px) rotate(1deg); }
            90% { transform: translate(-5px, 5px) rotate(0deg); }
            100% { transform: translate(0,0) rotate(0deg); }
        }
    </style>
</head>
<body>

<div id="ui">LEVEL: <span id="lvl">1</span> / 5</div>

<div id="start-screen">
    <div style="letter-spacing: 10px; font-size: 30px; font-weight: bold;">NEON <span style="color:var(--neon)">MAZE</span></div>
    <div style="color: #ff3e3e; font-size: 11px; margin-top: 25px; font-weight: bold; animation: blink 1s infinite;">⚠️ ВЫКЛЮЧИ БЕЗЗВУЧНЫЙ РЕЖИМ ⚠️</div>
    <button class="start-btn" id="goBtn">ИНИЦИАЛИЗАЦИЯ</button>
</div>

<canvas id="game"></canvas>
<div id="joy-outer"><div id="joy-stick"></div></div>

<div id="screamer">
    <img src="77307.jpg" id="scImg">
</div>

<audio id="bgm" src="bg-music.mp3" loop></audio>
<audio id="scm" src="scream.mp3"></audio>

<script>
    const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
    const bgm = document.getElementById('bgm'), scm = document.getElementById('scm');
    const joyStick = document.getElementById('joy-stick');
    
    let level = 1, cellSize, offX, offY, gameActive = false;
    let player = { x: 0, y: 0 };
    let finish = { x: 0, y: 0 };
    let walls = [], joy = { x: 0, y: 0, active: false };

    const maps = [
        [[1,1,1,1,1,1],[1,2,0,0,3,1],[1,1,1,1,1,1]],
        [[1,1,1,1,1],[1,2,1,3,1],[1,0,1,0,1],[1,0,0,0,1],[1,1,1,1,1]],
        [[1,1,1,1,1,1],[1,2,0,0,0,1],[1,1,1,1,0,1],[1,3,0,0,0,1],[1,1,1,1,1,1]],
        [[1,1,1,1,1,1,1],[1,2,0,1,0,0,1],[1,1,0,1,0,1,1],[1,0,0,0,0,3,1],[1,1,1,1,1,1,1]],
        [[1,1,1,1,1,1,1],[1,2,0,0,0,0,1],[1,1,1,1,1,0,1],[1,3,0,0,0,0,1],[1,1,1,1,1,1,1]]
    ];

    document.getElementById('goBtn').addEventListener('click', function() {
        bgm.play().catch(()=>{});
        scm.load(); // Предзагрузка без звука
        document.getElementById('start-screen').style.display = 'none';
        gameActive = true;
        init();
        loop();
    });

    function init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const m = maps[level-1];
        cellSize = Math.min(canvas.width / (m[0].length + 1), canvas.height / (m.length + 4));
        walls = [];
        offX = (canvas.width - m[0].length * cellSize) / 2;
        offY = (canvas.height - m.length * cellSize) / 2;
        for(let y=0; y<m.length; y++) {
            for(let x=0; x<m[y].length; x++) {
                let px = offX + x * cellSize, py = offY + y * cellSize;
                if(m[y][x] === 1) walls.push({x: px, y: py, w: cellSize, h: cellSize});
                if(m[y][x] === 2) { player.x = px + cellSize/2; player.y = py + cellSize/2; }
                if(m[y][x] === 3) { finish.x = px + cellSize/2; finish.y = py + cellSize/2; }
            }
        }
    }

    window.addEventListener('touchstart', e => { 
        const t = e.touches[0], r = document.getElementById('joy-outer').getBoundingClientRect();
        if(Math.hypot(t.clientX - (r.left+50), t.clientY - (r.top+50)) < 60) joy.active = true;
    });

    window.addEventListener('touchmove', e => {
        if(!joy.active) return;
        const t = e.touches[0], r = document.getElementById('joy-outer').getBoundingClientRect();
        let dx = t.clientX - (r.left+50), dy = t.clientY - (r.top+50);
        const d = Math.hypot(dx, dy);
        if(d > 30) { dx *= 30/d; dy *= 30/d; }
        joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
        joy.x = dx / 7; joy.y = dy / 7;
    });

    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; joyStick.style.transform = 'translate(0,0)'; });

    function loop() {
        if(!gameActive) return;
        if(joy.active) {
            let nx = player.x + joy.x, ny = player.y + joy.y, hit = false;
            walls.forEach(w => { if(nx+8 > w.x && nx-8 < w.x+w.w && ny+8 > w.y && ny-8 < w.y+w.h) hit = true; });
            if(!hit) { player.x = nx; player.y = ny; }
        }
        ctx.fillStyle = '#050508'; ctx.fillRect(0,0,canvas.width, canvas.height);
        walls.forEach(w => { ctx.strokeStyle = 'rgba(0, 243, 255, 0.4)'; ctx.strokeRect(w.x+2, w.y+2, w.w-4, w.h-4); });
        ctx.fillStyle = '#ff00ff'; ctx.beginPath(); ctx.arc(finish.x, finish.y, cellSize/5, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(player.x, player.y, 8, 0, Math.PI*2); ctx.fill();

        if(Math.hypot(player.x - finish.x, player.y - finish.y) < 15) {
            if(level < 5) { level++; document.getElementById('lvl').innerText = level; init(); } 
            else { 
                gameActive = false;
                bgm.pause();
                scm.currentTime = 0;
                scm.play();
                const sc = document.getElementById('screamer');
                sc.style.display = 'block';
                sc.classList.add('shake-active'); // ЗАПУСК ТРЯСКИ
                if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
            }
        }
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
